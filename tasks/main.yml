---
#- fail:
#    msg: RT downgrade is not supported
#  when: item.0|int < item.1|int
#  with_together:
#    - "{{ rt_version.split('.') }}"
#    - "{{ ansible_local.rt_versions['RT'].split('.') }}"

- block:
  - set_fact:
      upgrade: yes
    when: version_part.0|int > version_part.1|int
    with_together:
      - "{{ rt_version.split('.') }}"
      - "{{ ansible_local.rt_versions['RT'].split('.') }}"
    loop_control:
      loop_var: version_part

  when: ansible_local.rt_versions['RT'] is defined

# Don't run default tasks in refresh mode
- set_fact:
    defaults: no
  when: refresh_rt or refresh_database

- block:
  - name: Base RT system configuration
    include: base/main.yml

  - name: Download RT
    include: rt/download.yml

  - name: Configure RT installation
    include: rt/configure.yml
    
  - name: Fix RT dependencies
    include: rt/fixdeps.yml

  - name: Install RT
    include: rt/install.yml
    when: not upgrade

  - name: Upgrade RT
    include: rt/upgrade.yml
    when: upgrade

  - name: Initialize RT database
    include: rt/initialize_database.yml
    when: setup_database and not upgrade

  - name: Upgrade RT database
    include: rt/upgrade_database.yml
    when: setup_database and upgrade

  - name: Install RT extensions
    include: rt_extensions/main.yml
    with_items: "{{ rt_extensions }}"
    loop_control:
      loop_var: rt_extension

  environment:
    PERLBREW_ROOT: "{{ perlbrew_root }}"
  when: defaults

- name: Refresh RT
  include: refresh/main.yml
  environment:
    PERLBREW_ROOT: "{{ perlbrew_root }}"
  when: refresh_rt or refresh_database
